<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Raw Report ‚Äî Sushi Fish ID</title>
<style>
  :root { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial; }
  body { margin: 24px; max-width: 860px; }
  h1 { margin: 0 0 8px; }
  .sub { color:#6b7280; margin:0 0 16px; }
  .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin: 12px 0; background: #fff; }
  label { display:block; font-size:14px; margin:8px 0 6px; color:#374151; }
  input[type="file"], input[type="password"], input[type="text"] { width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 14px; }
  #preview { display:none; max-width:100%; border-radius:10px; margin-top:10px; }
  button { padding: 10px 14px; border: 1px solid #111827; background:#111827; color:#fff; border-radius:10px; font-weight:600; cursor:pointer; }
  button:disabled { opacity:.55; cursor:default; }
  .row { display:flex; gap:12px; flex-wrap: wrap; align-items: center; }
  .muted { color:#6b7280; font-size:13px; }
  pre { white-space: pre-wrap; word-break: break-word; font: 14px/1.45 ui-monospace, SFMono-Regular, Menlo, monospace; margin: 0; }
  .pill { font-size:12px; border:1px solid #d1d5db; border-radius:999px; padding:4px 8px; color:#374151; background:#f9fafb; }
  .error { background:#fff8f8; border:1px solid #f3b1b1; color:#8b0000; padding:10px; border-radius:8px; display:none; }
  .ok { background:#f6fff8; border:1px solid #b6e3c6; color:#065f46; padding:10px; border-radius:8px; display:none; }
</style>
</head>
<body>
  <h1>üêü The Raw Report ‚Äî Sushi Fish ID</h1>
  <p class="sub">Upload a sushi box photo ‚Üí get a left‚Äëto‚Äëright, row‚Äëby‚Äërow breakdown of fish & garnishes. One mode. No drawing.</p>

  <div class="card">
    <label>OpenAI API key <span class="muted">(stays in this page only)</span></label>
    <input id="apiKey" type="password" placeholder="sk-..." autocomplete="off" />
    <div class="row" style="margin-top:8px">
      <span class="pill">Tip: we‚Äôll add a backend later to hide your key</span>
    </div>
  </div>

  <div class="card">
    <label>Upload sushi photo</label>
    <input id="fileInput" type="file" accept="image/*" />
    <img id="preview" alt="preview" />
    <div class="muted" style="margin-top:6px">iPad: choose Photo Library or Browse.</div>
  </div>

  <div class="card">
    <label>Optional context (helps accuracy)</label>
    <input id="context" type="text" placeholder="e.g., came with tuna roll + miso, $48 delivered; Murray Hill; deluxe box" />
  </div>

  <div class="card">
    <div class="row">
      <button id="analyzeBtn">Identify Fish</button>
      <span id="status" class="muted"></span>
    </div>
    <div id="err" class="error" style="margin-top:10px"></div>
    <div id="ok" class="ok" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <label>Result</label>
    <pre id="out">(Results will appear here)</pre>
    <div class="row" style="margin-top:10px">
      <button id="copyBtn">Copy</button>
      <span class="muted" id="copyStatus"></span>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);
const fileInput = $('fileInput');
const preview = $('preview');
const analyzeBtn = $('analyzeBtn');
const out = $('out');
const statusEl = $('status');
const err = $('err');
const ok = $('ok');
const copyBtn = $('copyBtn');
const copyStatus = $('copyStatus');

fileInput.addEventListener('change', () => {
  const f = fileInput.files?.[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  preview.src = url;
  preview.style.display = 'block';
});

copyBtn.addEventListener('click', async () => {
  try {
    await navigator.clipboard.writeText(out.textContent || '');
    copyStatus.textContent = 'Copied.';
    setTimeout(()=>copyStatus.textContent='', 1500);
  } catch(e) {
    copyStatus.textContent = 'Copy failed ‚Äî select and copy manually.';
    setTimeout(()=>copyStatus.textContent='', 2000);
  }
});

function uiWorking(isWorking, msg='') {
  analyzeBtn.disabled = isWorking;
  statusEl.textContent = msg;
  err.style.display = 'none';
  ok.style.display = 'none';
}

function showError(message) {
  err.textContent = message;
  err.style.display = 'block';
}

function showOk(message) {
  ok.textContent = message;
  ok.style.display = 'block';
}

async function fileToDataURL(file) {
  return new Promise((res, rej) => {
    const reader = new FileReader();
    reader.onload = () => res(reader.result);
    reader.onerror = rej;
    reader.readAsDataURL(file);
  });
}

// Core: call OpenAI Vision with image as data URL
async function identifyFish() {
  const key = $('apiKey').value.trim();
  if (!key) throw new Error('Missing API key.');
  const f = fileInput.files?.[0];
  if (!f) throw new Error('Please choose an image first.');

  const dataUrl = await fileToDataURL(f);
  const userContext = $('context').value.trim();

  // System + user prompts tuned for your exact format
  const systemPrompt = `You are a precise sushi expert. Identify nigiri/sashimi/roll pieces and garnishes in a single photo. 
Return ONLY the analysis in the requested format. Be conservative: if uncertain, say "likely" or "unclear".`;

  const userPrompt = `
Analyze this single photo of a sushi box. I need a clean, copy-ready breakdown.

Rules:
- Go row by row, top to bottom. Within each row go left to right.
- Number the rows and the pieces.
- For each piece, name the fish (or item) and any visible garnish/sauce (e.g., yuzu kosho, scallion, jalape√±o, lemon, tobiko, grated ginger, shiso, sesame, eel sauce).
- Call out duplicates explicitly (e.g., "2x Hamachi").
- If pieces are torched/seared, say so.
- If you're unsure, say "likely" and give 1 alternative.
- At the end, add a short "Notes" section (2‚Äì4 bullets) with quality cues (rice warmth, cut quality, color/fat marbling, odd garnishes), and any obvious omissions (e.g., no toro).

Context from user (may help but is optional): ${userContext || '(none)'}.

FORMAT (exactly):
Row 1:
1) ...
2) ...
Row 2:
1) ...
2) ...
Row 3:
1) ...
2) ...
Notes:
- ...
- ...`;

  const body = {
    model: "gpt-4o-mini",
    temperature: 0.2,
    messages: [
      { role: "system", content: systemPrompt },
      { role: "user", content: [
          { type: "text", text: userPrompt },
          { type: "image_url", image_url: { url: dataUrl } }
        ]
      }
    ]
  };

  const resp = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${key}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body)
  });

  if (!resp.ok) {
    let msg = `${resp.status} ${resp.statusText}`;
    try { const j = await resp.json(); msg += ` ‚Äî ${j.error?.message || ''}` } catch {}
    throw new Error(`OpenAI API error: ${msg}`);
  }

  const j = await resp.json();
  const text = j.choices?.[0]?.message?.content?.trim() || '(no result)';
  return text;
}

analyzeBtn.addEventListener('click', async () => {
  out.textContent = '';
  uiWorking(true, 'Analyzing‚Ä¶');
  try {
    const result = await identifyFish();
    out.textContent = result;
    showOk('Done');
  } catch (e) {
    showError(e.message || String(e));
  } finally {
    uiWorking(false, '');
  }
});

// Crash catcher (renders errors on-page)
window.addEventListener('error', e => {
  showError(e.message);
});
window.addEventListener('unhandledrejection', e => {
  showError(String(e.reason || e));
});
</script>
</body>
</html>
