<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>üêü The Raw Report ‚Äî Sushi Fish ID</title>
<style>
  :root { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial; background:#1b1b1b; color:#e0e0e0; }
  body { margin:0 auto; max-width:900px; padding:20px; text-align:center; }
  img.logo { max-width:200px; margin:0 auto 15px; display:block; }
  h1 { margin:6px 0 14px; color:#39ff14; }
  p  { color:#bbb; }
  .card { border:1px solid #39ff14; border-radius:12px; padding:16px; margin:12px 0; background:#2a2a2a; }
  label { display:block; font-weight:700; margin-bottom:6px; color:#ff2fd0; }
  input[type="file"], input[type="text"] { width:100%; background:#111; color:#fff; border:1px solid #444; padding:8px; border-radius:6px; }
  button { background:#39ff14; color:#000; border:0; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:700; }
  button:hover { background:#2ddc0e; }
  #preview { max-width:100%; border-radius:8px; margin-top:10px; }
  pre { text-align:left; white-space:pre-wrap; background:#111; color:#fff; padding:10px; border-radius:8px; border:1px solid #444; min-height:120px; }
  .err { color:#ff6b6b; margin-top:8px; }
</style>
</head>
<body>

<!-- Logo file must exist in repo root as raw-report-logo.png -->
<img src="raw-report-logo.png" alt="The Raw Report Logo" class="logo" />

<h1>üêü The Raw Report ‚Äî Sushi Fish ID</h1>
<p>Upload a sushi box photo ‚Üí get a left‚Äëto‚Äëright, row‚Äëby‚Äërow breakdown of fish & garnishes.</p>

<div class="card">
  <label>Upload sushi photo</label>
  <input id="file" type="file" accept="image/*" />
  <img id="preview" alt="Preview" />
</div>

<div class="card">
  <label>Optional context (helps accuracy)</label>
  <input id="context" type="text" placeholder="e.g., comes with tuna roll + miso; $48 delivered; Murray Hill; deluxe box" />
</div>

<button id="identifyBtn">Identify Fish</button>

<div class="card">
  <label>Result</label>
  <pre id="result"> </pre>
  <div class="err" id="err"></div>
</div>

<script>
const apiKey = "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"; // <-- Replace with your full key (keep quotes)

const fileInput = document.getElementById('file');
const preview   = document.getElementById('preview');
const resultEl  = document.getElementById('result');
const errEl     = document.getElementById('err');
const btn       = document.getElementById('identifyBtn');

fileInput.addEventListener('change', () => {
  const f = fileInput.files[0];
  if (!f) return;
  preview.src = URL.createObjectURL(f);
  preview.style.display = 'block';
});

btn.addEventListener('click', async () => {
  errEl.textContent = '';
  const f = fileInput.files[0];
  if (!f) { errEl.textContent = "Please upload a sushi photo first."; return; }

  resultEl.textContent = "Identifying fish‚Ä¶";

  const base64 = await toBase64(f);
  const context = document.getElementById('context').value;

  const prompt = `
You are identifying sushi pieces in ONE photo.

OUTPUT FORMAT:
Row 1:
1) <fish/item> ‚Äî <garnish/sauce/notes>
2) ...
Row 2:
...
Notes:
- ...
- ...

RULES:
- Count total pieces first (including rolls) and ensure your breakdown covers them all.
- Go row-by-row (top to bottom), left-to-right.
- Number each piece. If multiple identical pieces are in the same row, write "n√ó <fish> ‚Äî ..." instead of repeating.
- Do NOT merge across rows unless they are visually identical with the same garnish.
- If uncertain, say "likely <fish>" and ONE alternative in parentheses.
- Use sushi-specific visual cues:
  ‚Ä¢ Salmon (sake): orange with white fat lines; belly has more marbling.
  ‚Ä¢ Tuna (maguro): deep red; chutoro is pink marbled; otoro is pale pink with heavy marbling.
  ‚Ä¢ Yellowtail (hamachi): beige‚Äëpink with a darker edge near skin.
  ‚Ä¢ Fluke (hirame): translucent white with fine grain.
  ‚Ä¢ Snapper (tai): translucent with red skin edge or crosshatch.
  ‚Ä¢ Mackerel (saba): silver skin with stripes; often vinegared.
  ‚Ä¢ Escolar (butterfish): opaque white, dense texture.
  ‚Ä¢ Scallop (hotate): round, glossy white; torched if surface browned.
- Mention if toro is present, but do NOT state "no toro" if absent.
- Keep Notes short (2‚Äì3 bullets) in a Raw Report tone.
Extra context (may help accuracy): ${context}
`;

  try {
    const resp = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: "gpt-4o",
        temperature: 0.1,
        messages: [
          { role: "system", content: "You are a sushi expert who visually identifies fish in photos with high precision." },
          { role: "user", content: [
              { type: "text", text: prompt },
              { type: "image_url", image_url: { url: base64 } }
            ] }
        ],
        max_tokens: 700
      })
    });

    const data = await resp.json();

    if (!resp.ok) {
      const msg = (data && data.error && data.error.message) ? data.error.message : (resp.status + " " + resp.statusText);
      errEl.textContent = "API error: " + msg;
      resultEl.textContent = "";
      return;
    }

    const text = data?.choices?.[0]?.message?.content?.trim();
    resultEl.textContent = text || JSON.stringify(data, null, 2);

  } catch (e) {
    errEl.textContent = "Request failed: " + (e.message || e);
    resultEl.textContent = "";
  }
});

function toBase64(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.readAsDataURL(file);
    r.onload = () => resolve(r.result);
    r.onerror = reject;
  });
}
</script>

</body>
</html>
